{% extends "base.html" %}

{% block title %}数据采集管理{% endblock %}

{% block content %}
<style>
    .search-card { margin-top: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .search-header { font-weight: bold; font-size: 16px; padding: 15px 20px; border-bottom: 1px solid #f0f0f0; }
    .layui-form-item { margin-bottom: 0; }
    .result-card { transition: all 0.3s; border-radius: 8px; border: 1px solid #eee; overflow: hidden; }
    .result-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .card-cover { height: 160px; background: #f8f8f8; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
    .card-cover img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
    .result-card:hover .card-cover img { transform: scale(1.05); }
    .card-content { padding: 15px; }
    .card-title { font-size: 15px; font-weight: 600; line-height: 1.4; height: 42px; overflow: hidden; margin-bottom: 8px; }
    .card-title a { color: #333; }
    .card-title a:hover { color: #1E9FFF; }
    .card-meta { font-size: 12px; color: #999; margin-bottom: 10px; display: flex; justify-content: space-between; }
    .card-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f6f6f6; }
    .status-badge { position: absolute; top: 10px; right: 10px; z-index: 10; }
    .select-checkbox { position: absolute; top: 10px; left: 10px; z-index: 10; transform: scale(1.2); }
    
    /* Custom scrollbar for card content if needed */
    .card-desc { font-size: 12px; color: #666; height: 36px; overflow: hidden; line-height: 1.5; margin-bottom: 10px; }
</style>

<div class="layui-container">
    <!-- Search Section -->
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card search-card">
                <div class="layui-card-header search-header">
                    <i class="layui-icon layui-icon-search" style="margin-right: 8px; color: #1E9FFF;"></i>数据采集配置
                </div>
                <div class="layui-card-body" style="padding: 20px;">
                    <form class="layui-form" action="" lay-filter="searchForm">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">数据源</label>
                                <div class="layui-input-inline" style="width: 150px;">
                                    <select name="source">
                                        <option value="baidu" selected>百度搜索</option>
                                        <option value="xinhua">新华网-四川</option>
                                        <option value="sohu">搜狐新闻</option>
                                    </select>
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label">关键词</label>
                                <div class="layui-input-inline" style="width: 250px;">
                                    <input type="text" name="keyword" required lay-verify="required" placeholder="请输入采集关键词" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            
                            <div class="layui-inline">
                                <label class="layui-form-label">采集页数</label>
                                <div class="layui-input-inline" style="width: 100px;">
                                    <input type="number" name="pages" value="1" min="1" max="20" class="layui-input" lay-verify="number">
                                </div>
                            </div>
                            
                            <div class="layui-inline">
                                <label class="layui-form-label">数量限制</label>
                                <div class="layui-input-inline" style="width: 100px;">
                                    <input type="number" name="limit" placeholder="不限" min="1" class="layui-input">
                                </div>
                            </div>
                            
                            <div class="layui-inline">
                                <button class="layui-btn layui-btn-normal" lay-submit lay-filter="formScrape">
                                    <i class="layui-icon layui-icon-release"></i> 开始采集
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Progress Bar -->
                    <div id="progressContainer" style="display: none; margin-top: 25px; padding: 0 20px;">
                        <div class="layui-progress layui-progress-big" lay-showpercent="true" lay-filter="scrapeProgress">
                            <div class="layui-progress-bar layui-bg-blue" lay-percent="0%"></div>
                        </div>
                        <div id="progressMsg" style="margin-top: 10px; text-align: center; color: #666; font-size: 13px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="layui-row layui-col-space15" id="resultSection" style="display: none; margin-top: 10px;">
        <div class="layui-col-md12">
            <div class="layui-card" style="border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <div class="layui-card-header" style="padding: 0 20px; display: flex; align-items: center; justify-content: space-between;">
                    <div class="layui-form">
                        <input type="checkbox" lay-filter="selectAll" title="全选本次结果" lay-skin="primary">
                        <span style="margin-left: 10px; font-weight: bold;">采集结果</span>
                    </div>
                    <div>
                        <span id="resultCount" style="color: #999; margin-right: 15px; font-size: 12px;"></span>
                        <button class="layui-btn layui-btn-sm" id="btnBatchSave">
                            <i class="layui-icon layui-icon-save"></i> 批量入库
                        </button>
                    </div>
                </div>
                <div class="layui-card-body" style="background-color: #f8f9fa; padding: 20px;">
                    <div id="dataContainer" class="layui-row layui-col-space20">
                        <!-- Cards will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template for Data Item -->
<script id="dataItemTpl" type="text/html">
    {% raw %}
    {{#  layui.each(d.list, function(index, item){ }}
    <div class="layui-col-md3 layui-col-sm6">
        <div class="layui-card result-card">
            <div class="layui-card-body" style="padding: 0;">
                <div class="card-cover">
                    <div class="select-checkbox">
                        <input type="checkbox" name="selectItem" value="{{ index }}" lay-skin="primary">
                    </div>
                    <div class="status-badge">
                        <span class="layui-badge {{ item.is_deep_crawled ? 'layui-bg-green' : 'layui-bg-gray' }}" id="status-{{ index }}">
                            {{ item.is_deep_crawled ? '已深度采集' : '未深度采集' }}
                        </span>
                    </div>
                    
                    {{# if(item.cover){ }}
                    <a href="{{ item.original_url }}" target="_blank" title="点击访问原地址">
                        <img src="{{ item.cover }}" alt="{{ item.title }}">
                    </a>
                    {{# } else { }}
                    <a href="{{ item.original_url }}" target="_blank" title="点击访问原地址">
                        <img src="{{ d.defaultImg }}" alt="默认封面">
                    </a>
                    {{# } }}
                </div>
                
                <div class="card-content">
                    <h3 class="card-title">
                        <a href="{{ item.original_url }}" target="_blank" title="{{ item.title }}">{{ item.title }}</a>
                    </h3>
                    
                    <div class="card-desc" title="{{ item.summary }}">
                        {{ item.summary || '暂无摘要...' }}
                    </div>
                    
                    <div class="card-meta">
                        <span><i class="layui-icon layui-icon-website"></i> {{ item.source.length > 10 ? item.source.substring(0, 10) + '...' : item.source }}</span>
                        <span>{{ item.publish_date || '' }}</span>
                    </div>
                    
                    <div class="card-actions">
                        <button class="layui-btn layui-btn-primary layui-btn-xs layui-border-blue btn-deep-crawl" data-index="{{ index }}" data-url="{{ item.original_url }}">
                            <i class="layui-icon layui-icon-engine"></i> 深度采集
                        </button>
                        <button class="layui-btn layui-btn-xs btn-save" data-index="{{ index }}">
                            <i class="layui-icon layui-icon-ok"></i> 保存
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {{#  }); }}
    {% endraw %}
</script>
{% endblock %}

{% block scripts %}
<script>
layui.use(['form', 'layer', 'laytpl', 'element'], function(){
  var form = layui.form;
  var layer = layui.layer;
  var laytpl = layui.laytpl;
  var element = layui.element;
  var $ = layui.$;
  
  var currentData = []; // Store scraped data globally
  var currentKeyword = '';
  var defaultImgUrl = "{{ url_for('static', filename='img/defalt_img.png') }}";

  // Scrape Form Submit
  form.on('submit(formScrape)', function(data){
    currentKeyword = data.field.keyword;
    var pages = data.field.pages;
    var limit = data.field.limit;
    var source = data.field.source;

    // Reset UI
    $('#resultSection').hide();
    $('#progressContainer').show();
    element.progress('scrapeProgress', '0%');
    $('#progressMsg').text('准备开始采集...');
    
    // Reset Select All checkbox
    $('input[lay-filter="selectAll"]').prop('checked', false);
    form.render('checkbox');
    
    // Use native fetch for streaming response
    var formData = new FormData();
    formData.append('keyword', currentKeyword);
    formData.append('source', source);
    formData.append('pages', pages);
    if(limit) formData.append('limit', limit);

    fetch("{{ url_for('business.analysis') }}", {
        method: 'POST',
        body: formData
    }).then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        function readStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    $('#progressMsg').text('采集完成');
                    element.progress('scrapeProgress', '100%');
                    return;
                }
                
                var chunk = decoder.decode(value, {stream: true});
                var lines = chunk.split('\n');
                
                lines.forEach(line => {
                    if(!line.trim()) return;
                    try {
                        var msg = JSON.parse(line);
                        if(msg.type === 'progress'){
                            var percent = Math.floor((msg.current / msg.total) * 100) + '%';
                            element.progress('scrapeProgress', percent);
                            $('#progressMsg').text(msg.msg);
                        } else if (msg.type === 'result'){
                            currentData = msg.data.map(item => {
                                item.keyword = currentKeyword;
                                item.is_deep_crawled = false;
                                item.content = '';
                                return item;
                            });
                            renderData();
                            $('#resultSection').show();
                            layer.msg('采集成功，共找到 ' + currentData.length + ' 条数据');
                        } else if (msg.type === 'error'){
                            layer.msg('采集出错: ' + msg.msg, {icon: 2});
                        }
                    } catch(e) {
                        console.error('Parse error', e);
                    }
                });
                
                readStream();
            });
        }
        readStream();
    }).catch(err => {
        console.error(err);
        layer.msg('请求失败', {icon: 2});
    });
    
    return false;
  });

  // Select All Logic
  form.on('checkbox(selectAll)', function(data){
      var child = $('input[name="selectItem"]');
      child.each(function(index, item){
          item.checked = data.elem.checked;
      });
      form.render('checkbox');
  });

  function renderData(){
      var getTpl = document.getElementById('dataItemTpl').innerHTML;
      var view = document.getElementById('dataContainer');
      laytpl(getTpl).render({list: currentData, defaultImg: defaultImgUrl}, function(html){
          view.innerHTML = html;
          form.render('checkbox'); // Re-render checkboxes
      });
      $('#resultCount').text('共 ' + currentData.length + ' 条');
  }

  // Deep Crawl Click
  $(document).on('click', '.btn-deep-crawl', function(){
      var index = $(this).data('index');
      var url = $(this).data('url');
      
      if(currentData[index].is_deep_crawled){
          layer.msg('该条目已深度采集');
          return;
      }
      
      var loadIdx = layer.msg('正在深度采集...', {icon: 16, shade: 0.3, time: 0});
      
      $.ajax({
          url: "{{ url_for('business.deep_crawl') }}",
          type: "POST",
          data: {url: url},
          success: function(res){
              layer.close(loadIdx);
              if(res.code === 0){
                  currentData[index].content = res.content;
                  currentData[index].is_deep_crawled = true;
                  
                  // Update UI
                  $('#status-' + index).removeClass('layui-bg-gray').addClass('layui-bg-green').text('已深度采集');
                  layer.msg('深度采集成功');
              } else {
                  layer.msg('深度采集失败: ' + res.msg, {icon: 2});
              }
          },
          error: function(){
              layer.close(loadIdx);
              layer.msg('请求失败', {icon: 2});
          }
      });
  });

  // Single Save
  $(document).on('click', '.btn-save', function(){
      var index = $(this).data('index');
      saveData([currentData[index]]);
  });

  // Batch Save
  $('#btnBatchSave').click(function(){
      var selectedItems = [];
      $('input[name="selectItem"]:checked').each(function(){
          var idx = $(this).val();
          selectedItems.push(currentData[idx]);
      });
      
      if(selectedItems.length === 0){
          layer.msg('请先选择要保存的数据');
          return;
      }
      
      saveData(selectedItems);
  });

  function saveData(items){
      var loadIdx = layer.msg('正在保存...', {icon: 16, shade: 0.3, time: 0});
      
      $.ajax({
          url: "{{ url_for('business.save_data') }}",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({items: items}),
          success: function(res){
              layer.close(loadIdx);
              if(res.code === 0){
                  layer.msg(res.msg, {icon: 1});
              } else {
                  layer.msg(res.msg, {icon: 2});
              }
          },
          error: function(){
              layer.close(loadIdx);
              layer.msg('请求失败', {icon: 2});
          }
      });
  }

});
</script>
{% endblock %}
